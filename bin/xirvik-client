#!/usr/bin/env python
from cgi import parse_header
from os.path import basename, expanduser, join as path_join, realpath
from netrc import netrc
import argparse
import logging
import re

import requests

from xirvik.client import ruTorrentClient
from xirvik.logging import get_logger
import xirvik.client

if __name__ == '__main__':
    parser = argparse.ArgumentParser()

    parser.add_argument('-H', '--host', required=True)
    parser.add_argument('-P', '--port', type=int, default=443)
    parser.add_argument('-c', '--netrc-path', default=expanduser('~/.netrc'))
    parser.add_argument('-o', '--output-path', default=realpath('.'))
    parser.add_argument('-d', '--debug', action='store_true')
    parser.add_argument('-v', '--verbose', action='store_true')

    args = parser.parse_args()
    verbose = args.debug or args.verbose
    log = get_logger('xirvik-client',
                     verbose=args.verbose,
                     debug=args.debug)
    if args.debug:
        #sh.logging_enabled = True
        logs_to_follow = (
            'requests.packages.urllib3',
            #'command',
            xirvik.client.LOG_NAME,
        )
        for name in logs_to_follow:
            _log = logging.getLogger(name)
            formatter = logging.Formatter('%(asctime)s - %(name)s - '
                                          '%(levelname)s - %(message)s')
            channel = logging.StreamHandler(sys.stderr)

            _log.setLevel(logging.DEBUG)
            channel.setLevel(logging.DEBUG)
            channel.setFormatter(formatter)
            _log.addHandler(channel)

    local_dir = realpath(args.output_path)
    user, _, password = netrc(args.netrc_path).authenticators(args.host)

    log.debug('Read user and password from netrc file')

    client = ruTorrentClient(args.host, user, password)
    http_prefix = 'https://{host:s}'.format(host=args.host)
    multirpc_action_uri = ('{}/rtorrent/plugins/multirpc/'
                           'action.php'.format(http_prefix))
    get_torrent_uri = ('{}/rtorrent/plugins/source/action.php'
                       '?hash='.format(http_prefix))

    for hash, v in client.list_torrents().items():
        print(v[4])
